# Databricks notebook source
import pyspark.sql.functions as F
import pandas as pd
import io

# COMMAND ----------

ref_age_columns_string = """ORIGINAL,SEX,AGE,AGE_ONE_YEAR,AGE_FIVE_YEAR,AGE_TEN_YEAR
FEMALE_110_111,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_111_112,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_106_107,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_107_108,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_71_72,FEMALE,71,FEMALE_71_72,FEMALE_70_74,FEMALE_70_79
FEMALE_72_73,FEMALE,72,FEMALE_72_73,FEMALE_70_74,FEMALE_70_79
FEMALE_61_62,FEMALE,61,FEMALE_61_62,FEMALE_60_64,FEMALE_60_69
FEMALE_65_66,FEMALE,65,FEMALE_65_66,FEMALE_65_69,FEMALE_60_69
FEMALE_83_84,FEMALE,83,FEMALE_83_84,FEMALE_80_84,FEMALE_80_89
FEMALE_74_75,FEMALE,74,FEMALE_74_75,FEMALE_70_74,FEMALE_70_79
FEMALE_11_12,FEMALE,11,FEMALE_11_12,FEMALE_10_14,FEMALE_10_19
FEMALE_12_13,FEMALE,12,FEMALE_12_13,FEMALE_10_14,FEMALE_10_19
FEMALE_27_28,FEMALE,27,FEMALE_27_28,FEMALE_25_29,FEMALE_20_29
FEMALE_48_49,FEMALE,48,FEMALE_48_49,FEMALE_45_49,FEMALE_40_49
FEMALE_44_45,FEMALE,44,FEMALE_44_45,FEMALE_40_44,FEMALE_40_49
FEMALE_35_36,FEMALE,35,FEMALE_35_36,FEMALE_35_39,FEMALE_30_39
MALE_106_107,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_107_108,MALE,95+,MALE_95+,MALE_95+,MALE_90+
FEMALE_58_59,FEMALE,58,FEMALE_58_59,FEMALE_55_59,FEMALE_50_59
FEMALE_59_60,FEMALE,59,FEMALE_59_60,FEMALE_55_59,FEMALE_50_59
FEMALE_103_104,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
MALE_41_42,MALE,41,MALE_41_42,MALE_40_44,MALE_40_49
MALE_42_43,MALE,42,MALE_42_43,MALE_40_44,MALE_40_49
FEMALE_6_7,FEMALE,6,FEMALE_6_7,FEMALE_5_9,FEMALE_0_9
FEMALE_0_1,FEMALE,0,FEMALE_0_1,FEMALE_0_4,FEMALE_0_9
MALE_61_62,MALE,61,MALE_61_62,MALE_60_64,MALE_60_69
MALE_53_54,MALE,53,MALE_53_54,MALE_50_54,MALE_50_59
MALE_82_83,MALE,82,MALE_82_83,MALE_80_84,MALE_80_89
MALE_22_23,MALE,22,MALE_22_23,MALE_20_24,MALE_20_29
MALE_87_88,MALE,87,MALE_87_88,MALE_85_89,MALE_80_89
MALE_36_37,MALE,36,MALE_36_37,MALE_35_39,MALE_30_39
MALE_83_84,MALE,83,MALE_83_84,MALE_80_84,MALE_80_89
FEMALE_24_25,FEMALE,24,FEMALE_24_25,FEMALE_20_24,FEMALE_20_29
FEMALE_25_26,FEMALE,25,FEMALE_25_26,FEMALE_25_29,FEMALE_20_29
MALE_108_109,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_24_25,MALE,24,MALE_24_25,MALE_20_24,MALE_20_29
MALE_25_26,MALE,25,MALE_25_26,MALE_25_29,MALE_20_29
MALE_6_7,MALE,6,MALE_6_7,MALE_5_9,MALE_0_9
MALE_5_6,MALE,5,MALE_5_6,MALE_5_9,MALE_0_9
FEMALE_97_98,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_98_99,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_39_40,FEMALE,39,FEMALE_39_40,FEMALE_35_39,FEMALE_30_39
FEMALE_78_79,FEMALE,78,FEMALE_78_79,FEMALE_75_79,FEMALE_70_79
FEMALE_23_24,FEMALE,23,FEMALE_23_24,FEMALE_20_24,FEMALE_20_29
FEMALE_69_70,FEMALE,69,FEMALE_69_70,FEMALE_65_69,FEMALE_60_69
FEMALE_31_32,FEMALE,31,FEMALE_31_32,FEMALE_30_34,FEMALE_30_39
FEMALE_20_21,FEMALE,20,FEMALE_20_21,FEMALE_20_24,FEMALE_20_29
FEMALE_21_22,FEMALE,21,FEMALE_21_22,FEMALE_20_24,FEMALE_20_29
FEMALE_37_38,FEMALE,37,FEMALE_37_38,FEMALE_35_39,FEMALE_30_39
FEMALE_38_39,FEMALE,38,FEMALE_38_39,FEMALE_35_39,FEMALE_30_39
MALE_97_98,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_98_99,MALE,95+,MALE_95+,MALE_95+,MALE_90+
FEMALE_112_113,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_105_106,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_108_109,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_93_94,FEMALE,93,FEMALE_93_94,FEMALE_90_94,FEMALE_90+
FEMALE_94_95,FEMALE,94,FEMALE_94_95,FEMALE_90_94,FEMALE_90+
MALE_46_47,MALE,46,MALE_46_47,MALE_45_49,MALE_40_49
MALE_47_48,MALE,47,MALE_47_48,MALE_45_49,MALE_40_49
MALE_71_72,MALE,71,MALE_71_72,MALE_70_74,MALE_70_79
MALE_72_73,MALE,72,MALE_72_73,MALE_70_74,MALE_70_79
MALE_58_59,MALE,58,MALE_58_59,MALE_55_59,MALE_50_59
MALE_59_60,MALE,59,MALE_59_60,MALE_55_59,MALE_50_59
MALE_78_79,MALE,78,MALE_78_79,MALE_75_79,MALE_70_79
MALE_56_57,MALE,56,MALE_56_57,MALE_55_59,MALE_50_59
MALE_74_75,MALE,74,MALE_74_75,MALE_70_74,MALE_70_79
MALE_75_76,MALE,75,MALE_75_76,MALE_75_79,MALE_70_79
MALE_73_74,MALE,73,MALE_73_74,MALE_70_74,MALE_70_79
MALE_31_32,MALE,31,MALE_31_32,MALE_30_34,MALE_30_39
MALE_62_63,MALE,62,MALE_62_63,MALE_60_64,MALE_60_69
MALE_93_94,MALE,93,MALE_93_94,MALE_90_94,MALE_90+
MALE_94_95,MALE,94,MALE_94_95,MALE_90_94,MALE_90+
MALE_90_91,MALE,90,MALE_90_91,MALE_90_94,MALE_90+
MALE_105_106,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_112_113,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_99_100,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_96_97,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_95_96,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_54_55,MALE,54,MALE_54_55,MALE_50_54,MALE_50_59
MALE_55_56,MALE,55,MALE_55_56,MALE_55_59,MALE_50_59
FEMALE_101_102,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_102_103,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_75_76,FEMALE,75,FEMALE_75_76,FEMALE_75_79,FEMALE_70_79
FEMALE_15_16,FEMALE,15,FEMALE_15_16,FEMALE_15_19,FEMALE_10_19
FEMALE_19_20,FEMALE,19,FEMALE_19_20,FEMALE_15_19,FEMALE_10_19
FEMALE_79_80,FEMALE,79,FEMALE_79_80,FEMALE_75_79,FEMALE_70_79
FEMALE_66_67,FEMALE,66,FEMALE_66_67,FEMALE_65_69,FEMALE_60_69
FEMALE_73_74,FEMALE,73,FEMALE_73_74,FEMALE_70_74,FEMALE_70_79
FEMALE_18_19,FEMALE,18,FEMALE_18_19,FEMALE_15_19,FEMALE_10_19
FEMALE_70_71,FEMALE,70,FEMALE_70_71,FEMALE_70_74,FEMALE_70_79
FEMALE_62_63,FEMALE,62,FEMALE_62_63,FEMALE_60_64,FEMALE_60_69
MALE_101_102,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_102_103,MALE,95+,MALE_95+,MALE_95+,MALE_90+
FEMALE_91_92,FEMALE,91,FEMALE_91_92,FEMALE_90_94,FEMALE_90+
FEMALE_117_118,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_100_101,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_3_4,FEMALE,3,FEMALE_3_4,FEMALE_0_4,FEMALE_0_9
FEMALE_4_5,FEMALE,4,FEMALE_4_5,FEMALE_0_4,FEMALE_0_9
MALE_76_77,MALE,76,MALE_76_77,MALE_75_79,MALE_70_79
MALE_77_78,MALE,77,MALE_77_78,MALE_75_79,MALE_70_79
MALE_50_51,MALE,50,MALE_50_51,MALE_50_54,MALE_50_59
MALE_51_52,MALE,51,MALE_51_52,MALE_50_54,MALE_50_59
FEMALE_1_2,FEMALE,1,FEMALE_1_2,FEMALE_0_4,FEMALE_0_9
MALE_70_71,MALE,70,MALE_70_71,MALE_70_74,MALE_70_79
MALE_69_70,MALE,69,MALE_69_70,MALE_65_69,MALE_60_69
MALE_40_41,MALE,40,MALE_40_41,MALE_40_44,MALE_40_49
MALE_43_44,MALE,43,MALE_43_44,MALE_40_44,MALE_40_49
FEMALE_84_85,FEMALE,84,FEMALE_84_85,FEMALE_80_84,FEMALE_80_89
FEMALE_85_86,FEMALE,85,FEMALE_85_86,FEMALE_85_89,FEMALE_80_89
FEMALE_54_55,FEMALE,54,FEMALE_54_55,FEMALE_50_54,FEMALE_50_59
FEMALE_55_56,FEMALE,55,FEMALE_55_56,FEMALE_55_59,FEMALE_50_59
MALE_109_110,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_100_101,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_103_104,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_116_117,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_84_85,MALE,84,MALE_84_85,MALE_80_84,MALE_80_89
MALE_85_86,MALE,85,MALE_85_86,MALE_85_89,MALE_80_89
MALE_1_2,MALE,1,MALE_1_2,MALE_0_4,MALE_0_9
MALE_2_3,MALE,2,MALE_2_3,MALE_0_4,MALE_0_9
FEMALE_118_119,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_119_120,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_114_115,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_115_116,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_88_89,FEMALE,88,FEMALE_88_89,FEMALE_85_89,FEMALE_80_89
FEMALE_89_90,FEMALE,89,FEMALE_89_90,FEMALE_85_89,FEMALE_80_89
FEMALE_82_83,FEMALE,82,FEMALE_82_83,FEMALE_80_84,FEMALE_80_89
FEMALE_53_54,FEMALE,53,FEMALE_53_54,FEMALE_50_54,FEMALE_50_59
FEMALE_32_33,FEMALE,32,FEMALE_32_33,FEMALE_30_34,FEMALE_30_39
FEMALE_36_37,FEMALE,36,FEMALE_36_37,FEMALE_35_39,FEMALE_30_39
FEMALE_22_23,FEMALE,22,FEMALE_22_23,FEMALE_20_24,FEMALE_20_29
MALE_118_119,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_119_120,MALE,95+,MALE_95+,MALE_95+,MALE_90+
FEMALE_76_77,FEMALE,76,FEMALE_76_77,FEMALE_75_79,FEMALE_70_79
FEMALE_77_78,FEMALE,77,FEMALE_77_78,FEMALE_75_79,FEMALE_70_79
FEMALE_46_47,FEMALE,46,FEMALE_46_47,FEMALE_45_49,FEMALE_40_49
FEMALE_47_48,FEMALE,47,FEMALE_47_48,FEMALE_45_49,FEMALE_40_49
FEMALE_50_51,FEMALE,50,FEMALE_50_51,FEMALE_50_54,FEMALE_50_59
FEMALE_51_52,FEMALE,51,FEMALE_51_52,FEMALE_50_54,FEMALE_50_59
FEMALE_80_81,FEMALE,80,FEMALE_80_81,FEMALE_80_84,FEMALE_80_89
FEMALE_81_82,FEMALE,81,FEMALE_81_82,FEMALE_80_84,FEMALE_80_89
FEMALE_63_64,FEMALE,63,FEMALE_63_64,FEMALE_60_64,FEMALE_60_69
FEMALE_64_65,FEMALE,64,FEMALE_64_65,FEMALE_60_64,FEMALE_60_69
FEMALE_116_117,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_96_97,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_95_96,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
MALE_20_21,MALE,20,MALE_20_21,MALE_20_24,MALE_20_29
MALE_21_22,MALE,21,MALE_21_22,MALE_20_24,MALE_20_29
MALE_37_38,MALE,37,MALE_37_38,MALE_35_39,MALE_30_39
MALE_38_39,MALE,38,MALE_38_39,MALE_35_39,MALE_30_39
MALE_11_12,MALE,11,MALE_11_12,MALE_10_14,MALE_10_19
MALE_12_13,MALE,12,MALE_12_13,MALE_10_14,MALE_10_19
FEMALE_2_3,FEMALE,2,FEMALE_2_3,FEMALE_0_4,FEMALE_0_9
MALE_57_58,MALE,57,MALE_57_58,MALE_55_59,MALE_50_59
MALE_52_53,MALE,52,MALE_52_53,MALE_50_54,MALE_50_59
MALE_65_66,MALE,65,MALE_65_66,MALE_65_69,MALE_60_69
MALE_86_87,MALE,86,MALE_86_87,MALE_85_89,MALE_80_89
MALE_18_19,MALE,18,MALE_18_19,MALE_15_19,MALE_10_19
MALE_39_40,MALE,39,MALE_39_40,MALE_35_39,MALE_30_39
MALE_91_92,MALE,91,MALE_91_92,MALE_90_94,MALE_90+
MALE_117_118,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_7_8,MALE,7,MALE_7_8,MALE_5_9,MALE_0_9
MALE_8_9,MALE,8,MALE_8_9,MALE_5_9,MALE_0_9
MALE_0_1,MALE,0,MALE_0_1,MALE_0_4,MALE_0_9
FEMALE_45_46,FEMALE,45,FEMALE_45_46,FEMALE_45_49,FEMALE_40_49
FEMALE_10_11,FEMALE,10,FEMALE_10_11,FEMALE_10_14,FEMALE_10_19
FEMALE_14_15,FEMALE,14,FEMALE_14_15,FEMALE_10_14,FEMALE_10_19
FEMALE_86_87,FEMALE,86,FEMALE_86_87,FEMALE_85_89,FEMALE_80_89
FEMALE_30_31,FEMALE,30,FEMALE_30_31,FEMALE_30_34,FEMALE_30_39
FEMALE_43_44,FEMALE,43,FEMALE_43_44,FEMALE_40_44,FEMALE_40_49
FEMALE_56_57,FEMALE,56,FEMALE_56_57,FEMALE_55_59,FEMALE_50_59
FEMALE_28_29,FEMALE,28,FEMALE_28_29,FEMALE_25_29,FEMALE_20_29
FEMALE_29_30,FEMALE,29,FEMALE_29_30,FEMALE_25_29,FEMALE_20_29
FEMALE_67_68,FEMALE,67,FEMALE_67_68,FEMALE_65_69,FEMALE_60_69
FEMALE_68_69,FEMALE,68,FEMALE_68_69,FEMALE_65_69,FEMALE_60_69
FEMALE_33_34,FEMALE,33,FEMALE_33_34,FEMALE_30_34,FEMALE_30_39
FEMALE_34_35,FEMALE,34,FEMALE_34_35,FEMALE_30_34,FEMALE_30_39
FEMALE_16_17,FEMALE,16,FEMALE_16_17,FEMALE_15_19,FEMALE_10_19
FEMALE_17_18,FEMALE,17,FEMALE_17_18,FEMALE_15_19,FEMALE_10_19
FEMALE_109_110,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_104_105,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_7_8,FEMALE,7,FEMALE_7_8,FEMALE_5_9,FEMALE_0_9
FEMALE_8_9,FEMALE,8,FEMALE_8_9,FEMALE_5_9,FEMALE_0_9
MALE_80_81,MALE,80,MALE_80_81,MALE_80_84,MALE_80_89
MALE_81_82,MALE,81,MALE_81_82,MALE_80_84,MALE_80_89
MALE_33_34,MALE,33,MALE_33_34,MALE_30_34,MALE_30_39
MALE_34_35,MALE,34,MALE_34_35,MALE_30_34,MALE_30_39
MALE_28_29,MALE,28,MALE_28_29,MALE_25_29,MALE_20_29
MALE_29_30,MALE,29,MALE_29_30,MALE_25_29,MALE_20_29
MALE_16_17,MALE,16,MALE_16_17,MALE_15_19,MALE_10_19
MALE_17_18,MALE,17,MALE_17_18,MALE_15_19,MALE_10_19
FEMALE_5_6,FEMALE,5,FEMALE_5_6,FEMALE_5_9,FEMALE_0_9
MALE_10_11,MALE,10,MALE_10_11,MALE_10_14,MALE_10_19
MALE_14_15,MALE,14,MALE_14_15,MALE_10_14,MALE_10_19
MALE_13_14,MALE,13,MALE_13_14,MALE_10_14,MALE_10_19
MALE_23_24,MALE,23,MALE_23_24,MALE_20_24,MALE_20_29
MALE_48_49,MALE,48,MALE_48_49,MALE_45_49,MALE_40_49
MALE_44_45,MALE,44,MALE_44_45,MALE_40_44,MALE_40_49
MALE_32_33,MALE,32,MALE_32_33,MALE_30_34,MALE_30_39
MALE_35_36,MALE,35,MALE_35_36,MALE_35_39,MALE_30_39
MALE_113_114,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_104_105,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_3_4,MALE,3,MALE_3_4,MALE_0_4,MALE_0_9
MALE_4_5,MALE,4,MALE_4_5,MALE_0_4,MALE_0_9
MALE_9_10,MALE,9,MALE_9_10,MALE_5_9,MALE_0_9
FEMALE_52_53,FEMALE,52,FEMALE_52_53,FEMALE_50_54,FEMALE_50_59
FEMALE_40_41,FEMALE,40,FEMALE_40_41,FEMALE_40_44,FEMALE_40_49
FEMALE_57_58,FEMALE,57,FEMALE_57_58,FEMALE_55_59,FEMALE_50_59
FEMALE_41_42,FEMALE,41,FEMALE_41_42,FEMALE_40_44,FEMALE_40_49
FEMALE_42_43,FEMALE,42,FEMALE_42_43,FEMALE_40_44,FEMALE_40_49
FEMALE_60_61,FEMALE,60,FEMALE_60_61,FEMALE_60_64,FEMALE_60_69
FEMALE_13_14,FEMALE,13,FEMALE_13_14,FEMALE_10_14,FEMALE_10_19
FEMALE_87_88,FEMALE,87,FEMALE_87_88,FEMALE_85_89,FEMALE_80_89
FEMALE_49_50,FEMALE,49,FEMALE_49_50,FEMALE_45_49,FEMALE_40_49
FEMALE_26_27,FEMALE,26,FEMALE_26_27,FEMALE_25_29,FEMALE_20_29
MALE_110_111,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_111_112,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_114_115,MALE,95+,MALE_95+,MALE_95+,MALE_90+
MALE_115_116,MALE,95+,MALE_95+,MALE_95+,MALE_90+
FEMALE_92_93,FEMALE,92,FEMALE_92_93,FEMALE_90_94,FEMALE_90+
FEMALE_90_91,FEMALE,90,FEMALE_90_91,FEMALE_90_94,FEMALE_90+
FEMALE_113_114,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_99_100,FEMALE,95+,FEMALE_95+,FEMALE_95+,FEMALE_90+
FEMALE_9_10,FEMALE,9,FEMALE_9_10,FEMALE_5_9,FEMALE_0_9
MALE_88_89,MALE,88,MALE_88_89,MALE_85_89,MALE_80_89
MALE_89_90,MALE,89,MALE_89_90,MALE_85_89,MALE_80_89
MALE_63_64,MALE,63,MALE_63_64,MALE_60_64,MALE_60_69
MALE_64_65,MALE,64,MALE_64_65,MALE_60_64,MALE_60_69
MALE_67_68,MALE,67,MALE_67_68,MALE_65_69,MALE_60_69
MALE_68_69,MALE,68,MALE_68_69,MALE_65_69,MALE_60_69
MALE_15_16,MALE,15,MALE_15_16,MALE_15_19,MALE_10_19
MALE_66_67,MALE,66,MALE_66_67,MALE_65_69,MALE_60_69
MALE_79_80,MALE,79,MALE_79_80,MALE_75_79,MALE_70_79
MALE_19_20,MALE,19,MALE_19_20,MALE_15_19,MALE_10_19
MALE_27_28,MALE,27,MALE_27_28,MALE_25_29,MALE_20_29
MALE_26_27,MALE,26,MALE_26_27,MALE_25_29,MALE_20_29
MALE_60_61,MALE,60,MALE_60_61,MALE_60_64,MALE_60_69
MALE_30_31,MALE,30,MALE_30_31,MALE_30_34,MALE_30_39
MALE_49_50,MALE,49,MALE_49_50,MALE_45_49,MALE_40_49
MALE_45_46,MALE,45,MALE_45_46,MALE_45_49,MALE_40_49
MALE_92_93,MALE,92,MALE_92_93,MALE_90_94,MALE_90+"""

attribute_mapping_string = """Indicator_description,Indicator,Attribute_description,Attribute_ID
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions baseline non-standardised numerator,d4909836-9bc8-11ed-a8fc-0242ac120002
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions non-standardised numerator,d4909566-9bc8-11ed-a8fc-0242ac120002
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions standardised numerator,D3C64D53-20CF-43E7-B15B-1AA8613F7B74
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions baseline denominator,88337490-8A59-4C40-8C13-FF0D9D01F48D
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions baseline numerator,0871C126-B4C3-4054-A0C0-2481525A940F
NCD013 Indicator,FB4334A8-2E9C-43AB-9D1F-51C4A4F14E6B,Patient contact during Care Home Round,982C9A99-A4EA-48FB-ABE9-B60B3E2F1719
NCD022 Indicator,E1B4261F-8649-42D0-A40E-208AA41F8EAE,ACSC Emergency Admissions denominator,D388FDB3-E3D7-44F2-80C7-0832B448C9B4
NCD026 Indicator,283A5FDD-D4BA-4DF7-AC70-B59C83285D3E,ACC-08 Denominator,FB4D2185-044E-44A4-9C11-02A0A4034A02
NCD013 Indicator,FB4334A8-2E9C-43AB-9D1F-51C4A4F14E6B,EHCH-04 Numerator,982C9A99-A4EA-48FB-ABE9-B60B3E2F1719
NCD013 Indicator,472596E3-E60B-4DFF-8D54-283A6B58AA7B,ACC-02 Numerator,2F9C4BBA-4A2C-452D-BB68-2639FE715908
NCD026 Indicator,283A5FDD-D4BA-4DF7-AC70-B59C83285D3E,ACC-08 Numerator,767390F9-FD7E-4B01-A8AE-82B41DE00A02"""

def create_ref_tables():
  ref_age_columns_pd_df = pd.read_csv(io.StringIO(ref_age_columns_string), header=0, delimiter=',').astype(str)
  ref_age_columns_df = spark.createDataFrame(ref_age_columns_pd_df)
  create_table('ref_age_columns', 'iif_indicators_collab', ref_age_columns_df)
  
  
  attribute_mapping_pd_df = pd.read_csv(io.StringIO(attribute_mapping_string), header=0, delimiter=',').astype(str)
  attribute_mapping_df = spark.createDataFrame(attribute_mapping_pd_df)
  create_table('attribute_mapping', 'iif_indicators_collab', attribute_mapping_df)
  print('Ref tables saved')


# COMMAND ----------

def get_base_data_df():
  """
  Returns the base GP appointment data to derive the indicator info for ehch04 
  """
  
  basedata_df = spark.sql("""
  SELECT 
    supplier AS Supplier,
    gp_code AS GP_Code,
    time_between_booking_and_appt AS Wait_Time,
    context_type AS Context_Type,
    appt_status AS Appointment_Status,
    national_category AS National_Slot_Type,
    appt_count AS Appointments,
    appt_date AS Appointment_Date
  FROM prim_wntr_press_collab.raw_appt_data
  WHERE 
    APPT_DATE >= '{start}'
    AND
    APPT_DATE <= '{end}'
  """.format(start=start_financial_year.isoformat(), end=report_end.isoformat()))

  basedata_df.filter(F.col('Context_Type') == 'Care Related Encounter')
  basedata_df.filter(basedata_df['Appointment_Status'].isin(['Unknown', 'Attended', 'Seen', 'DNA']))
  
  return basedata_df

# COMMAND ----------

def get_gp_practices():
  """
  Get a list of all GP Practices so we can add them back in if they have value = 0
  """
  
  gp_practices = basedata_df.select('GP_Code').distinct().collect()
  gp_practices = [practice[0] for practice in gp_practices]
  return gp_practices